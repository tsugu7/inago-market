# 市場データリアルタイム表示Webアプリケーション設計書

## 1. 要求仕様の解釈

### 1.1 概要
本Webアプリケーションは、先物市場のデータをAPI経由でリアルタイムに取得し、視覚的に表示するシステムです。特に売買出来高（約定数）に焦点を当て、トレーダーが市場の動向をリアルタイムで把握できるようにします。

### 1.2 主要要件の解釈

#### 対象契約
以下の先物契約を対象とします：
- ES: E-mini S&P 500先物
- MSE: Micro E-mini S&P 500先物
- NQ: E-mini NASDAQ-100先物
- MNQ: Micro E-mini NASDAQ-100先物
- CL: 原油先物
- MCL: Micro 原油先物
- GC: 金先物
- MGC: Micro 金先物

これらは主要な先物市場の商品であり、トレーダーにとって重要な指標となります。

#### リアルタイム更新
市場データは継続的に更新され、ユーザーに最新の情報を提供します：
- 棒グラフは1秒ごとに更新
- 表示は5秒単位で進行
- 価格情報は常に最新の状態を維持
- 約定数（出来高）は10秒ごとに累積値を計算

#### 視覚的表現
データの視覚化において以下の表現方法を採用します：
- 買い注文（正の値）は緑色
- 売り注文（負の値）は赤色
- 約定数の大きさに応じたボックスの塗りつぶし（0〜200の範囲）
- 時系列での出来高の変化を棒グラフで表現

## 2. システム概要

### 2.1 システムの目的
本システムは、トレーダーが複数の先物契約の市場動向をリアルタイムで監視し、売買の判断材料とするためのツールです。特に出来高（約定数）に焦点を当て、市場の勢いや方向性を視覚的に把握できるようにします。

### 2.2 主要機能
1. 複数の先物契約の価格と出来高データのリアルタイム取得
2. 選択した契約の出来高を時系列で表示する棒グラフ
3. 全対象契約の現在価格と累積約定数の一覧表示
4. 約定数の視覚的表現（色分けと塗りつぶし）
5. 契約の切り替え機能

### 2.3 ユーザー体験
ユーザーは画面上部の選択リストから監視したい契約を選択できます。選択した契約の出来高データがリアルタイムで棒グラフに表示され、市場の動きを視覚的に確認できます。また、画面下部では全ての対象契約の現在価格と出来高の概要を一目で確認できます。

## 3. アーキテクチャ設計

### 3.1 全体アーキテクチャ

本システムは以下の3層アーキテクチャで構成されます：

1. **フロントエンド層**：
   - ユーザーインターフェース（UI）
   - データ可視化コンポーネント
   - WebSocketクライアント

2. **バックエンド層**：
   - API Gateway
   - WebSocketサーバー
   - データ処理サービス

3. **データソース層**：
   - 市場データAPI（ProjectX Gateway APIなど）

### 3.2 コンポーネント構成

```
+------------------------+      +------------------------+      +------------------------+
|    フロントエンド層     |      |     バックエンド層      |      |    データソース層     |
|                        |      |                        |      |                        |
|  +------------------+  |      |  +------------------+  |      |  +------------------+  |
|  |      UI          |  |      |  |   API Gateway    |  |      |  |  市場データAPI   |  |
|  +------------------+  |      |  +------------------+  |      |  +------------------+  |
|           |            |      |           |            |      |           ^            |
|  +------------------+  |      |  +------------------+  |      |           |            |
|  | データ可視化     |<-|------|->| WebSocketサーバー|<-|------|-----------|            |
|  +------------------+  |      |  +------------------+  |      |                        |
|           |            |      |           |            |      |                        |
|  +------------------+  |      |  +------------------+  |      |                        |
|  | WebSocketクライアント|<-----|->| データ処理サービス |<-|------|-----------|            |
|  +------------------+  |      |  +------------------+  |      |                        |
+------------------------+      +------------------------+      +------------------------+
```

### 3.3 データフロー

1. バックエンドのデータ処理サービスが市場データAPIから定期的にデータを取得
2. 取得したデータを処理し、必要な情報を抽出・計算
3. WebSocketサーバーを通じてフロントエンドにリアルタイムでデータを送信
4. フロントエンドのWebSocketクライアントがデータを受信
5. データ可視化コンポーネントが受信したデータを棒グラフや価格表示に反映
6. UIが更新され、ユーザーに最新情報を表示

## 4. 画面設計

### 4.1 全体レイアウト

```
+----------------------------------------------------------------------+
|                                                                      |
|  [契約選択リスト: ES | MSE | NQ | MNQ | CL | MCL | GC | MGC]         |
|                                                                      |
+----------------------------------------------------------------------+
|                                                                      |
|                                                                      |
|                         出来高棒グラフ表示領域                        |
|                                                                      |
|                                                                      |
|                                                                      |
+----------------------------------------------------------------------+
|  +--------+  +--------+  +--------+  +--------+                      |
|  |   ES   |  |   MSE  |  |   NQ   |  |   MNQ  |                      |
|  | 価格   |  | 価格   |  | 価格   |  | 価格   |                      |
|  | [====] |  | [==  ] |  | [=====]|  | [===  ]|                      |
|  +--------+  +--------+  +--------+  +--------+                      |
|                                                                      |
|  +--------+  +--------+  +--------+  +--------+                      |
|  |   CL   |  |   MCL  |  |   GC   |  |   MGC  |                      |
|  | 価格   |  | 価格   |  | 価格   |  | 価格   |                      |
|  | [=    ]|  | [     ]|  | [==   ]|  | [=    ]|                      |
|  +--------+  +--------+  +--------+  +--------+                      |
|                                                                      |
+----------------------------------------------------------------------+
```

### 4.2 コンポーネント詳細

#### 4.2.1 契約選択リスト
- 形式: ドロップダウンリストまたはタブ形式
- デフォルト選択: NQ
- 機能: 選択変更時に棒グラフ表示を対応する契約データに切り替え

#### 4.2.2 出来高棒グラフ
- X軸: 時間（5秒単位で進行）
- Y軸: 約定数（正の値=買い、負の値=売り）
- 更新頻度: 1秒ごと
- 表示期間: 直近1〜2分程度（画面幅に応じて調整）
- 色分け: 買い=緑、売り=赤
- スケール: 自動調整（データの範囲に応じて）

#### 4.2.3 契約情報表示パネル
- 表示項目: 契約名、現在価格、10秒間の累積約定数
- 視覚表現: 約定数に応じたプログレスバー（0〜200の範囲、200で完全塗りつぶし）
- 色分け: 正の約定数=緑、負の約定数=赤
- レイアウト: グリッド形式（2行4列）
- 更新頻度: リアルタイム（価格は即時反映、約定数は10秒ごとに集計）

## 5. データモデル

### 5.1 契約データモデル

```typescript
interface Contract {
  symbol: string;       // 契約シンボル（ES, NQ, CLなど）
  displayName: string;  // 表示名
  currentPrice: number; // 現在価格
  priceChange: number;  // 価格変動（前回比）
  cumulativeVolume: {   // 累積出来高
    buy: number;        // 買い注文の累積
    sell: number;       // 売り注文の累積
    net: number;        // 正味の累積（買い-売り）
    timestamp: number;  // タイムスタンプ
  };
}
```

### 5.2 出来高データモデル

```typescript
interface VolumeData {
  symbol: string;       // 契約シンボル
  timestamp: number;    // データのタイムスタンプ
  interval: number;     // データの間隔（秒）
  buyVolume: number;    // 買い注文の出来高
  sellVolume: number;   // 売り注文の出来高
  netVolume: number;    // 正味の出来高（買い-売り）
}
```

### 5.3 チャートデータモデル

```typescript
interface ChartData {
  symbol: string;       // 契約シンボル
  data: Array<{         // 時系列データ
    timestamp: number;  // タイムスタンプ
    netVolume: number;  // 正味の出来高
  }>;
  timeRange: number;    // 表示する時間範囲（秒）
  intervalSize: number; // 各棒の間隔（秒）
}
```

## 6. API設計

### 6.1 WebSocket API

#### 6.1.1 接続エンドポイント
```
ws://[hostname]/api/market/ws
```

#### 6.1.2 メッセージ形式

**サーバーからクライアントへのメッセージ**

1. 価格更新メッセージ
```json
{
  "type": "price_update",
  "data": {
    "symbol": "NQ",
    "price": 15782.50,
    "timestamp": 1621234567890
  }
}
```

2. 出来高更新メッセージ
```json
{
  "type": "volume_update",
  "data": {
    "symbol": "NQ",
    "buyVolume": 120,
    "sellVolume": 85,
    "netVolume": 35,
    "timestamp": 1621234567890,
    "interval": 10
  }
}
```

3. チャートデータ更新メッセージ
```json
{
  "type": "chart_update",
  "data": {
    "symbol": "NQ",
    "timestamp": 1621234567890,
    "netVolume": 35
  }
}
```

**クライアントからサーバーへのメッセージ**

1. 契約購読メッセージ
```json
{
  "type": "subscribe",
  "symbols": ["NQ", "ES", "CL", "GC"]
}
```

2. 契約選択メッセージ
```json
{
  "type": "select_contract",
  "symbol": "NQ"
}
```

### 6.2 REST API

#### 6.2.1 契約リスト取得
- エンドポイント: `GET /api/contracts`
- 応答:
```json
{
  "contracts": [
    {
      "symbol": "ES",
      "displayName": "E-mini S&P 500",
      "currentPrice": 4235.75
    },
    {
      "symbol": "NQ",
      "displayName": "E-mini NASDAQ-100",
      "currentPrice": 15782.50
    },
    // 他の契約...
  ]
}
```

#### 6.2.2 特定契約の履歴データ取得
- エンドポイント: `GET /api/history/{symbol}?interval={interval}&duration={duration}`
- パラメータ:
  - symbol: 契約シンボル（ES, NQなど）
  - interval: データ間隔（秒）
  - duration: 取得する期間（秒）
- 応答:
```json
{
  "symbol": "NQ",
  "interval": 5,
  "data": [
    {
      "timestamp": 1621234567890,
      "netVolume": 35
    },
    // 他のデータポイント...
  ]
}
```

## 7. 技術スタック

### 7.1 フロントエンド
- **フレームワーク**: React.js
- **状態管理**: Redux または Context API
- **チャートライブラリ**: D3.js または Chart.js
- **WebSocket**: Socket.io-client または標準WebSocket API
- **スタイリング**: CSS Modules または Styled Components

### 7.2 バックエンド
- **サーバー**: Node.js + Express
- **WebSocket**: Socket.io または ws
- **データ処理**: RxJS（リアクティブプログラミング）
- **API通信**: Axios または node-fetch

### 7.3 インフラストラクチャ
- **デプロイ**: Docker + Kubernetes または AWS Elastic Beanstalk
- **CI/CD**: GitHub Actions または Jenkins
- **モニタリング**: Prometheus + Grafana

## 8. 実装上の考慮点

### 8.1 パフォーマンス最適化
- WebSocketを使用したリアルタイム通信の効率化
- フロントエンドでのレンダリングパフォーマンスの最適化
- バックエンドでのデータ処理の効率化
- 必要に応じたデータの間引きや集約

### 8.2 スケーラビリティ
- 多数の同時接続ユーザーに対応するためのWebSocketサーバーの水平スケーリング
- マイクロサービスアーキテクチャの採用による柔軟な拡張性
- キャッシュ層の導入による負荷分散

### 8.3 信頼性
- 市場データAPIとの接続断の検出と再接続メカニズム
- WebSocket接続の監視と自動再接続
- エラー処理とフォールバックメカニズム
- データの整合性チェック

### 8.4 セキュリティ
- WebSocket接続の認証と認可
- API呼び出しの制限とレート制限
- データの検証と無害化
- HTTPS/WSSの使用による通信の暗号化

### 8.5 ユーザビリティ
- レスポンシブデザインによる様々なデバイスへの対応
- ダークモード/ライトモードの切り替え
- アクセシビリティへの配慮
- 直感的なUI/UXの設計

## 9. 開発ロードマップ

### フェーズ1: 基本機能実装
- バックエンドの市場データAPI連携
- WebSocketサーバーの実装
- 基本的なUI実装
- 単一契約の出来高表示

### フェーズ2: 機能拡張
- 複数契約の同時監視
- 契約切り替え機能
- データの視覚化強化
- パフォーマンス最適化

### フェーズ3: 高度な機能
- ユーザー設定の保存
- アラート機能
- 追加の分析指標
- モバイル対応の強化

## 10. まとめ

本設計書では、市場データをリアルタイムに表示するWebアプリケーションの要件解釈と設計を行いました。特に出来高データの視覚化に焦点を当て、トレーダーが市場の動向を素早く把握できるようなインターフェースを設計しています。

WebSocketを活用したリアルタイム通信と、効率的なデータ処理・視覚化により、ユーザーに価値のある市場情報を提供します。また、スケーラビリティや信頼性を考慮した設計により、安定したサービスの提供を目指します。

本設計に基づいて実装を進めることで、要求仕様を満たす高品質なWebアプリケーションを構築することができます。
